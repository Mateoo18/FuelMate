{% extends "accounts/base.html" %}

{% block title %}Panel Administratora{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Panel Administratora</h1>
    <hr>

    <div class="mt-4 mb-4 text-center">
        <a href="{% url 'add_prices:nearest_stations' %}" class="btn btn-primary me-2">Dodaj Cenę Paliwa</a>
        <a href="{% url 'admin_panel:delete_prices' %}" class="btn btn-danger">Usuń Cenę Paliwa</a>
        <button id="refresh-stations-btn" class="btn btn-success ms-2">Odśwież Polecane Stacje</button>
    </div>

    <!-- Pasek postępu -->
    <div id="progress-container" class="mt-3" style="display: none;">
        <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
        </div>
        <p class="mt-2 text-center">Odświeżanie w toku...</p>
    </div>

    <div class="row">
        <!-- Zgłoszenia -->
        <div class="col-md-6">
            <h2>Zgłoszenia</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Stacja</th>
                        <th>Użytkownik</th>
                        <th>Data zgłoszenia</th>
                        <th>Komentarz</th>
                    </tr>
                </thead>
                <tbody>
                    {% for complain in complain %}
                    <tr>
                        <td>{{ complain.id }}</td>
                        <td>{{ complain.station.Name }}</td>
                        <td>{{ complain.user }}</td>
                        <td>{{ complain.date_created }}</td>
                        <td>{{ complain.text }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">Brak zgłoszeń do wyświetlenia.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Anomalie Cenowe -->
        <div class="col-md-6" style="border: 2px dashed #ccc; padding: 20px; text-align: center;">
            <h2>Anomalie Cenowe</h2>
            <p>W przyszłości tutaj zostaną wyświetlone dane dotyczące anomalii cenowych.</p>
        </div>
    </div>
</div>

<script>
    document.getElementById('refresh-stations-btn').addEventListener('click', function() {
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');

        // Wyświetl pasek postępu
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';

        // Wywołanie AJAX
        fetch("{% url 'admin_panel:refresh_stations' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = progress + '%';

                    if (progress >= 100) {
                        clearInterval(interval);
                        progressContainer.style.display = 'none';
                        alert('Najlepsze stacje zostały odświeżone!');
                    }
                }, 200);
            } else {
                throw new Error('Błąd podczas odświeżania danych.');
            }
        })
        .catch(error => {
            console.error(error);
            progressContainer.style.display = 'none';
            alert('Wystąpił problem podczas odświeżania najlepszych stacji.');
        });
    });
</script>
{% endblock %}
